# Storedsafe API ruby wrapper

This is a ruby wrapper for the Storedsafe REST-like API (See full [docs here](https://tracker.storedsafe.com/projects/storedsafe20/wiki/Version_10_release_documentation)).

**This early version may contain errors and is subject to change and should be used with caution**

## Install

Install from rubygems `gem install storedsafe`

Add to Gemfile `gem 'storedsafe', '~> 0.0.1'`

## Usage
To pass a manual configuration, you simply pass a block to *Storedsafe.configure*.
```
api = Storedsafe.configure do |config|
  config.server = 'storedsafe.example.com'
  config.api_token = 'abc123'
  config.token = 'secret'
  config.username = 'bob'
end
```

If you only want to use the built-in defaults you can skip the block.
```
api = Storedsafe.configure
```

See [Configuration](#configuration) for more info about default values and external configuration sources.

All methods of the `Storedsafe::API` object returns the data parsed by whichever parser is listed in your config's *parser* field. By default the `Storedsafe::Parser::RawParser` is used, which simply turns the returned JSON data into a Ruby hash.

### Authentication
If you already have a token from another source, you can enter it in the config and skip this section.

Three forms of authentication are currently availble. Either by the default *TOTP* (`Storedsafe::API::LogintType::TOTP`), *yubikey* (`Storedsafe::API::LoginType::YUBIKEY`) or *smartcard* (`Storedsafe::API::LoginType::SMARTCARD`).

NOTE: Make sure all other relevant fields are set on the Storedsafe::API object (username, api\_key)

Example authenticating using TOTP (sets the *token* field of the Storedsafe::API object).
```
api.authenticate('abc123', '123456')
```

Example authenticating using YubiKey.
```
api.authenticate('abc123', 'abcdef123456', Storedsafe::API::LoginType::YUBIKEY)
```

### Vaults
* list\_vaults
* list\_objects(vault\_id)
* create\_vault(groupname, policy, description)
* edit\_vault(vault\_id, { groupname, policy, description })
* delete\_vault(vault\_id)

### Templates
* list\_templates
* retrieve\_template(template\_id)

### Objects
* object(object\_id, decrypt=false)
* create\_object(template\_id, group\_id, parent\_id, object\_name, template\_args)
* edit\_object(object\_id, template\_id, group\_id, parent\_id, object\_name, template\_args)
* delete\_object(object\_id)
* find\_object(needle)

## Configuration
Configuration can be done in a few different ways. Other than the manual configuration, external configuration sources can be defined in the *config\_sources* array. By default this array will contain a `Storedsafe::Config::RcReader` and a `Storedsafe::Config::EnvReader`.

The order of priority between these different configuration sources are:
1. Manual Configuration
2. Built-in defaults
3. Elements in the config\_sources array in order of appearance

The **RcReader** will extract a configuration hash from a file (default is ~/.storedsafe-client.rc) which is generated by the [Storedsafe Tokenhandler](https://github.com/storedsafe/tokenhandler).

The **EnvReader** will extract a configuration hash from environment variables. By default these variables are `STOREDSAFE_SERVER`, `STOREDSAFE_TOKEN`, `STOREDSAFE_CABUNDLE` and `STOREDSAFE_SKIP_VERIFY`.

To disable all external configuration sources such as the rc-file and environment vairables, set the *config\_sources* option to an empty array.
```
api = Storedsafe.configure do |config|
  config.config_sources = []
  ...
end
```

To add your own external configuration source, you can use the template below.
```
class CustomReader
  def read
    {
      key: value
    }
  end
end
```

And then add it to the config_sources array.
```
api = Storedsafe.configure do |config|
  config.config_sources = [CustomReader.new]
  ...
end
```
